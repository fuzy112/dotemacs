#!/usr/bin/env bash

set -e

declare -a args
unset "args[@]"

provider=deepseek

for arg in "$@"; do
    case "$arg" in
        --deepseek)
            provider=deepseek
            ;;
        --kimi|--moonshot)
            provider=moonshot
            ;;
        *)
            args+=("$arg")
            ;;
    esac
done

case "$provider" in
    deepseek)
        export ANTHROPIC_BASE_URL=https://api.deepseek.com/anthropic
        ANTHROPIC_API_KEY="$(secret-tool lookup host api.deepseek.com)"
        export ANTHROPIC_MODEL=deepseek-chat
        export ANTHROPIC_SMALL_FAST_MODEL=deepseek-chat
        ;;
    moonshot)
        export ANTHROPIC_BASE_URL=https://api.moonshot.cn/anthropic
        ANTHROPIC_API_KEY="$(secret-tool lookup host api.moonshot.cn)"
        export ANTHROPIC_MODEL=kimi-k2-turbo-preview
        export ANTHROPIC_SMALL_FAST_MODEL=kimi-k2-turbo-preview
        ;;
esac
export ANTHROPIC_API_KEY

CLAUDE_CODE_CLI=
if command -v claude >/dev/null; then
	CLAUDE_CODE_CLI=claude
elif command -v nix >/dev/null; then
	# Use nix shell to run claude if nix is available
	CLAUDE_CODE_CLI="nix shell nixpkgs#claude-code --command claude --"
else
	CLAUDE_CODE_CLI="npm exec --package=@anthropic-ai/claude-code@latest claude --"
fi

exec $CLAUDE_CODE_CLI "${args[@]}"
